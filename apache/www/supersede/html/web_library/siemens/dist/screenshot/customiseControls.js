!function(global){"use strict";var fabric=global.fabric||(global.fabric={}),extCompat="1.6",isVML=function(){return"undefined"!=typeof G_vmlCanvasManager},degreesToRadians=fabric.util.degreesToRadians,cursorOffset={mt:0,tr:1,mr:2,br:3,mb:4,bl:5,ml:6,tl:7};global.fabric.version.indexOf(extCompat)===-1&&console.warn("this extension might not be fully compatible with your version of fabric.js ("+global.fabric.version+").Consider using the latest compatible build of fabric.js"+extCompat),fabric.util.object.extend(fabric.Object.prototype,{useCustomIcons:!1,cornerBackgroundColor:"transparent",cornerShape:"",cornerPadding:0,customiseCornerIcons:function(obj,callback){var setting;for(setting in obj)obj.hasOwnProperty(setting)&&(void 0!==obj[setting].cornerShape&&(this.cornerShape=obj[setting].cornerShape),void 0!==obj[setting].cornerBackgroundColor&&(this.cornerBackgroundColor=obj[setting].cornerBackgroundColor),void 0!==obj[setting].borderColor&&(this.borderColor=obj[setting].borderColor),void 0!==obj[setting].cornerSize&&(this.cornerSize=obj[setting].cornerSize),void 0!==obj[setting].cornerPadding&&(this.cornerPadding=obj[setting].cornerPadding),void 0!==obj[setting].icon&&(this.useCustomIcons=!0,this.loadIcon(setting,obj[setting].icon,function(){callback&&"function"==typeof callback&&callback()})))},loadIcon:function(corner,iconUrl,callback){var self=this,icon=new Image;icon.onload=function(){self[corner+"Icon"]=this,callback&&"function"==typeof callback&&callback()},icon.onerror=function(){fabric.warn(this.src+" icon is not an image")},iconUrl.indexOf("http")>-1&&(icon.crossOrigin="Anonymous"),icon.src=iconUrl},customizeCornerIcons:function(obj){this.customiseCornerIcons(obj)},drawControls:function(ctx){if(!this.hasControls)return this;var methodName,wh=this._calculateCurrentDimensions(!0),width=wh.x,height=wh.y,scaleOffset=this.cornerSize,left=-(width+scaleOffset)/2,top=-(height+scaleOffset)/2;return this.useCustomIcons?methodName="drawImage":(ctx.lineWidth=1,ctx.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,ctx.strokeStyle=ctx.fillStyle=this.cornerColor,methodName=this.transparentCorners?"strokeRect":"fillRect"),ctx.save(),this._drawControl("tl",ctx,methodName,left,top,this.tlIcon),this._drawControl("tr",ctx,methodName,left+width,top,this.trIcon),this._drawControl("bl",ctx,methodName,left,top+height,this.blIcon),this._drawControl("br",ctx,methodName,left+width,top+height,this.brIcon),this.get("lockUniScaling")||(this._drawControl("mt",ctx,methodName,left+width/2,top,this.mtIcon),this._drawControl("mb",ctx,methodName,left+width/2,top+height,this.mbIcon),this._drawControl("mr",ctx,methodName,left+width,top+height/2,this.mrIcon),this._drawControl("ml",ctx,methodName,left,top+height/2,this.mlIcon)),this.hasRotatingPoint&&this._drawControl("mtr",ctx,methodName,left+width/2,top-this.rotatingPointOffset,this.mtrIcon),ctx.restore(),this},_drawControl:function(control,ctx,methodName,left,top,icon){if(this.isControlVisible(control)){var size=this.cornerSize,cornerBG=this.cornerBackgroundColor||"black",cornerShape=this.cornerShape||"rect",cornerPadding=this.cornerPadding||10;if(this.useCustomIcons)if(cornerShape)switch(ctx.globalAlpha=1,ctx.fillStyle=cornerBG,cornerShape){case"rect":ctx.fillRect(left,top,size,size),void 0!==icon&&ctx[methodName](icon,left+cornerPadding/2,top+cornerPadding/2,size-cornerPadding,size-cornerPadding);break;case"circle":ctx.beginPath(),ctx.arc(left+size/2,top+size/2,size/2,0,2*Math.PI),ctx.fill(),ctx.closePath(),void 0!==icon&&ctx[methodName](icon,left+cornerPadding/2,top+cornerPadding/2,size-cornerPadding,size-cornerPadding)}else void 0!==icon&&ctx[methodName](icon,left,top,size,size);else isVML()||this.transparentCorners||ctx.clearRect(left,top,size,size),ctx[methodName](left,top,size,size)}}}),fabric.util.object.extend(fabric.Canvas.prototype,{overwriteActions:!1,fixedCursors:!1,customiseControls:function(obj){var setting;for(setting in obj)obj.hasOwnProperty(setting)&&(void 0!==obj[setting].action&&(this.overwriteActions=!0,this.setCustomAction(setting,obj[setting].action)),void 0!==obj[setting].cursor&&(this.fixedCursors=!0,this.setCustomCursor(setting,obj[setting].cursor)))},setCustomAction:function(corner,action){this[corner+"Action"]=action},setCustomCursor:function(corner,cursorUrl){this[corner+"cursorIcon"]=cursorUrl},customizeControls:function(obj){this.customiseControls(obj)},_getActionFromCorner:function(target,corner,e){if(!corner)return"drag";if(corner)if(this[corner+"Action"]&&this.overwriteActions)switch(corner){case"mtr":return this[corner+"Action"]||"rotate";case"ml":case"mr":return e.shiftKey?e.shiftKey?"skewY":"scaleX":this[corner+"Action"];case"mt":case"mb":return e.shiftKey?e.shiftKey?"skewY":"scaleY":this[corner+"Action"];default:return this[corner+"Action"]||"scale"}else switch(corner){case"mtr":return"rotate";case"ml":case"mr":return e.shiftKey?"skewY":"scaleX";case"mt":case"mb":return e.shiftKey?"skewX":"scaleY";default:return"scale"}},_setupCurrentTransform:function(e,target){if(target){var pointer=this.getPointer(e),corner=target._findTargetCorner(this.getPointer(e,!0)),action=this._getActionFromCorner(target,corner,e),origin=this._getOriginFromCorner(target,corner),_this=this;"function"==typeof action&&action.call(_this,e,target),this._currentTransform={target:target,action:action,corner:corner,scaleX:target.scaleX,scaleY:target.scaleY,skewX:target.skewX,skewY:target.skewY,offsetX:pointer.x-target.left,offsetY:pointer.y-target.top,originX:origin.x,originY:origin.y,ex:pointer.x,ey:pointer.y,lastX:pointer.x,lastY:pointer.y,left:target.left,top:target.top,theta:degreesToRadians(target.angle),width:target.width*target.scaleX,mouseXSign:1,mouseYSign:1,shiftKey:e.shiftKey,altKey:e.altKey},this._currentTransform.original={left:target.left,top:target.top,scaleX:target.scaleX,scaleY:target.scaleY,skewX:target.skewX,skewY:target.skewY,originX:origin.x,originY:origin.y},"remove"===action&&this._removeAction(e,target),"moveUp"===action&&this._moveLayerUpAction(e,target),"moveDown"===action&&this._moveLayerDownAction(e,target),"object"==typeof action&&"rotateByDegrees"===Object.keys(action)[0]&&this._rotateByDegrees(e,target,action.rotateByDegrees),this._resetCurrentTransform(e)}},_removeAction:function(e,target){var _this=this;this.getActiveGroup()&&"undefined"!==this.getActiveGroup()?(this.getActiveGroup().forEachObject(function(o){o.remove()}),this.discardActiveGroup(),setTimeout(function(){_this.deactivateAll()},0)):(target.remove(),setTimeout(function(){_this.deactivateAll()},0))},_moveLayerUpAction:function(e,target){this.getActiveGroup()&&"undefined"!==this.getActiveGroup()?this.getActiveGroup().forEachObject(function(o){o.bringForward()}):target.bringForward()},_moveLayerDownAction:function(e,target){this.getActiveGroup()&&"undefined"!==this.getActiveGroup()?this.getActiveGroup().forEachObject(function(o){o.sendBackwards()}):target.sendBackwards()},_rotateByDegrees:function(e,target,value){var angle=parseInt(target.getAngle())+value,needsOriginRestore=!1;"center"===target.originX&&"center"===target.originY||!target.centeredRotation||(this._setOriginToCenter(target),needsOriginRestore=!0),angle=angle>360?angle-360:angle,this.getActiveGroup()&&"undefined"!==this.getActiveGroup()?this.getActiveGroup().forEachObject(function(obj){obj.setAngle(angle).setCoords()}):target.setAngle(angle).setCoords(),needsOriginRestore&&this._setCenterToOrigin(target),this.renderAll()},_setOriginToCenter:function(target){target._originalOriginX=target.originX,target._originalOriginY=target.originY;var center=target.getCenterPoint();target.set({originX:"center",originY:"center",left:center.x,top:center.y})},_setCenterToOrigin:function(target){var originPoint=target.translateToOriginPoint(target.getCenterPoint(),target._originalOriginX,target._originalOriginY);target.set({originX:target._originalOriginX,originY:target._originalOriginY,left:originPoint.x,top:originPoint.y})},_setCornerCursor:function(corner,target,e){var iconUrlPattern=/\.(?:jpe?g|png|gif|jpg|jpeg|svg)$/;if(this.fixedCursors&&this[corner+"cursorIcon"])iconUrlPattern.test(this[corner+"cursorIcon"])?this.setCursor("url("+this[corner+"cursorIcon"]+"), auto"):"resize"===this[corner+"cursorIcon"]?this.setCursor(this._getRotatedCornerCursor(corner,target,e)):this.setCursor(this[corner+"cursorIcon"]);else if(corner in cursorOffset)this.setCursor(this._getRotatedCornerCursor(corner,target,e));else{if("mtr"!==corner||!target.hasRotatingPoint)return this.setCursor(this.defaultCursor),!1;this.setCursor(this.rotationCursor)}}})}("undefined"!=typeof exports?exports:this);