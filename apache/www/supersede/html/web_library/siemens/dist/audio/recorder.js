!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.Recorder=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";module.exports=require("./recorder").Recorder},{"./recorder":2}],2:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.Recorder=void 0;var _inlineWorker=require("inline-worker"),_inlineWorker2=_interopRequireDefault(_inlineWorker),Recorder=exports.Recorder=function(){function Recorder(source,cfg){var _this=this;_classCallCheck(this,Recorder),this.config={bufferLen:4096,numChannels:2,recordingCallback:function(){},mimeType:"audio/wav"},this.recording=!1,this.callbacks={getBuffer:[],exportWAV:[]},Object.assign(this.config,cfg),this.context=source.context,this.node=(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,this.config.bufferLen,this.config.numChannels,this.config.numChannels);var $that=this;this.node.onaudioprocess=function(e){if(_this.recording){for(var channelData,buffer=[],channel=0;channel<_this.config.numChannels;channel++)buffer.push(e.inputBuffer.getChannelData(channel)),channelData=e.inputBuffer.getChannelData(channel),buffer.push(channelData),$that.config.recordingCallback(channelData);_this.worker.postMessage({command:"record",buffer:buffer})}},source.connect(this.node),this.node.connect(this.context.destination);var self={};this.worker=new _inlineWorker2["default"](function(){function init(config){sampleRate=config.sampleRate,numChannels=config.numChannels,initBuffers()}function record(inputBuffer){for(var channel=0;channel<numChannels;channel++)recBuffers[channel].push(inputBuffer[channel]);recLength+=inputBuffer[0].length}function exportWAV(type){for(var buffers=[],channel=0;channel<numChannels;channel++)buffers.push(mergeBuffers(recBuffers[channel],recLength));var interleaved=void 0;interleaved=2===numChannels?interleave(buffers[0],buffers[1]):buffers[0];var dataview=encodeWAV(interleaved),audioBlob=new Blob([dataview],{type:type});self.postMessage({command:"exportWAV",data:audioBlob})}function getBuffer(){for(var buffers=[],channel=0;channel<numChannels;channel++)buffers.push(mergeBuffers(recBuffers[channel],recLength));self.postMessage({command:"getBuffer",data:buffers})}function clear(){recLength=0,recBuffers=[],initBuffers()}function initBuffers(){for(var channel=0;channel<numChannels;channel++)recBuffers[channel]=[]}function mergeBuffers(recBuffers,recLength){for(var result=new Float32Array(recLength),offset=0,i=0;i<recBuffers.length;i++)result.set(recBuffers[i],offset),offset+=recBuffers[i].length;return result}function interleave(inputL,inputR){for(var length=inputL.length+inputR.length,result=new Float32Array(length),index=0,inputIndex=0;index<length;)result[index++]=inputL[inputIndex],result[index++]=inputR[inputIndex],inputIndex++;return result}function floatTo16BitPCM(output,offset,input){for(var i=0;i<input.length;i++,offset+=2){var s=Math.max(-1,Math.min(1,input[i]));output.setInt16(offset,s<0?32768*s:32767*s,!0)}}function writeString(view,offset,string){for(var i=0;i<string.length;i++)view.setUint8(offset+i,string.charCodeAt(i))}function encodeWAV(samples){var buffer=new ArrayBuffer(44+2*samples.length),view=new DataView(buffer);return writeString(view,0,"RIFF"),view.setUint32(4,36+2*samples.length,!0),writeString(view,8,"WAVE"),writeString(view,12,"fmt "),view.setUint32(16,16,!0),view.setUint16(20,1,!0),view.setUint16(22,numChannels,!0),view.setUint32(24,sampleRate,!0),view.setUint32(28,4*sampleRate,!0),view.setUint16(32,2*numChannels,!0),view.setUint16(34,16,!0),writeString(view,36,"data"),view.setUint32(40,2*samples.length,!0),floatTo16BitPCM(view,44,samples),view}var recLength=0,recBuffers=[],sampleRate=void 0,numChannels=void 0;self.onmessage=function(e){switch(e.data.command){case"init":init(e.data.config);break;case"record":record(e.data.buffer);break;case"exportWAV":exportWAV(e.data.type);break;case"getBuffer":getBuffer();break;case"clear":clear()}}},self),this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:this.config.numChannels}}),this.worker.onmessage=function(e){var cb=_this.callbacks[e.data.command].pop();"function"==typeof cb&&cb(e.data.data)}}return _createClass(Recorder,[{key:"record",value:function(){this.recording=!0}},{key:"stop",value:function(){this.recording=!1}},{key:"clear",value:function(){this.worker.postMessage({command:"clear"})}},{key:"getBuffer",value:function(cb){if(cb=cb||this.config.callback,!cb)throw new Error("Callback not set");this.callbacks.getBuffer.push(cb),this.worker.postMessage({command:"getBuffer"})}},{key:"exportWAV",value:function(cb,mimeType){if(mimeType=mimeType||this.config.mimeType,cb=cb||this.config.callback,!cb)throw new Error("Callback not set");this.callbacks.exportWAV.push(cb),this.worker.postMessage({command:"exportWAV",type:mimeType})}},{key:"parseWav",value:function(wav){function readInt(i,bytes){for(var ret=0,shft=0;bytes;)ret+=wav[i]<<shft,shft+=8,i++,bytes--;return ret}if(1!=readInt(20,2))throw"Invalid compression code, not PCM";return{sampleRate:readInt(24,4),bitsPerSample:readInt(34,2),samples:wav.subarray(44)}}},{key:"Uint8ArrayToFloat32Array",value:function(u8a){for(var f32Buffer=new Float32Array(u8a.length),i=0;i<u8a.length;i++){var value=u8a[i<<1]+(u8a[(i<<1)+1]<<8);value>=32768&&(value|=-32768),f32Buffer[i]=value/32768}return f32Buffer}},{key:"encode64",value:function(buffer){for(var binary="",bytes=new Uint8Array(buffer),len=bytes.byteLength,i=0;i<len;i++)binary+=String.fromCharCode(bytes[i]);return window.btoa(binary)}},{key:"exportMP3",value:function(cb){this.exportWAV(function(){});var currCallback=cb||this.config.callback,$that=this,encoderWorker=new Worker(this.config.mp3WorkerPath);this.worker.onmessage=function(e){var arrayBuffer,blob=e.data.data,fileReader=new FileReader;fileReader.onload=function(){arrayBuffer=this.result;var buffer=new Uint8Array(arrayBuffer),data=$that.parseWav(buffer);encoderWorker.postMessage({cmd:"init",config:{mode:3,channels:1,samplerate:data.sampleRate,bitrate:data.bitsPerSample}}),encoderWorker.postMessage({cmd:"encode",buf:$that.Uint8ArrayToFloat32Array(data.samples)}),encoderWorker.onmessage=function(e){if("data"==e.data.cmd){var url="data:audio/mp3;base64,"+$that.encode64(e.data.buf);currCallback(url),console.log("Done converting to Mp3")}}},fileReader.readAsArrayBuffer(blob)}}}],[{key:"forceDownload",value:function(blob,filename){var url=(window.URL||window.webkitURL).createObjectURL(blob),link=window.document.createElement("a");link.href=url,link.download=filename||"output.wav";var click=document.createEvent("Event");click.initEvent("click",!0,!0),link.dispatchEvent(click)}}]),Recorder}();exports["default"]=Recorder},{"inline-worker":3}],3:[function(require,module,exports){"use strict";module.exports=require("./inline-worker")},{"./inline-worker":4}],4:[function(require,module,exports){(function(global){"use strict";var _createClass=function(){function defineProperties(target,props){for(var key in props){var prop=props[key];prop.configurable=!0,prop.value&&(prop.writable=!0)}Object.defineProperties(target,props)}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")},WORKER_ENABLED=!!(global===global.window&&global.URL&&global.Blob&&global.Worker),InlineWorker=function(){function InlineWorker(func,self){var _this=this;if(_classCallCheck(this,InlineWorker),WORKER_ENABLED){var functionBody=func.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],url=global.URL.createObjectURL(new global.Blob([functionBody],{type:"text/javascript"}));return new global.Worker(url)}this.self=self,this.self.postMessage=function(data){setTimeout(function(){_this.onmessage({data:data})},0)},setTimeout(function(){func.call(self)},0)}return _createClass(InlineWorker,{postMessage:{value:function(data){var _this=this;setTimeout(function(){_this.self.onmessage({data:data})},0)}}}),InlineWorker}();module.exports=InlineWorker}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1])(1)});